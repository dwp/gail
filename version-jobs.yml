create-alpha-version:
  stage: create-version
  image: alpine/git:v2.49.1@sha256:6a349a8e142f1e62429377904c5eff5ff3d956bfe2bdf8acc1a84c85794632eb
  before_script:
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  script:
    - git fetch --tags
    - latest_tag=$(git tag --sort=-v:refname | grep "rc." | head -n 1 || true)
    - latest_tag=${latest_tag:-"1.0.0"}
    - latest_alpha_tag=$(git tag --sort=-v:refname | grep "alpha" | head -n 1 || true)
    - latest_alpha_tag=${latest_alpha_tag:-"${latest_tag}-alpha.0"}
    - major=$(echo "$latest_tag" | awk -F. '{print $1}')
    - minor=$(echo "$latest_tag" | awk -F. '{print $2}')
    - |  
      if [[ "$(printf '%s\n' "$latest_tag" "$latest_alpha_tag" | sort -V | tail -n 1)" == "$latest_tag" ]]; then
        new_tag="${major}.$((minor + 1)).0-alpha.1"
      else
        alpha_version=$(echo "${latest_alpha_tag}" | awk -F. '{print $4}')
        version=$(echo "${latest_alpha_tag}" | awk -F'-alpha.' '{print $1}')
        new_alpha_version=$(($alpha_version + 1))
        new_tag="${version}-alpha.$new_alpha_version"
      fi
      
    - echo "IMAGE_VERSION=$new_tag" >> version.env
    - git remote set-url origin https://oauth2:${PROJECT_ACCESS_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git
    - git tag "$new_tag"
    - git push origin "$new_tag"
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: on_success
  artifacts:
    reports:
      dotenv: version.env
  tags:
    - docker

create-rc-version:
  stage: create-version
  image: alpine/git:v2.49.1@sha256:6a349a8e142f1e62429377904c5eff5ff3d956bfe2bdf8acc1a84c85794632eb
  variables:
    GIT_DEPTH: 0
  before_script:
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  script:
    - git fetch --tags
    - RELEASE_VERSION=$(echo "$CI_COMMIT_REF_NAME" | awk -F/ '{print $2 ".0"}')
    - EXISTING_RC=$(git tag --sort=-v:refname | grep "${RELEASE_VERSION}-rc" | head -n 1 || true)
    - |
      if [[ -z "$EXISTING_RC" ]]; then
        IMAGE_VERSION="${RELEASE_VERSION}-rc.1"
      else
        RC_NUM=$(echo "$EXISTING_RC" | awk -F-rc. '{print $2}')
        NEW_RC_NUM=$((RC_NUM + 1))
        IMAGE_VERSION="${RELEASE_VERSION}-rc.${NEW_RC_NUM}"
      fi
    - echo "IMAGE_VERSION=$IMAGE_VERSION" >> version.env
    - git remote set-url origin https://oauth2:${PROJECT_ACCESS_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git
    - git tag "$IMAGE_VERSION"
    - git push origin "$IMAGE_VERSION"
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^release\/.*$/
      when: on_success
  artifacts:
    reports:
      dotenv: version.env
  tags:
    - docker

create-hotfix-version:
  stage: create-version
  image: alpine/git:v2.49.1@sha256:6a349a8e142f1e62429377904c5eff5ff3d956bfe2bdf8acc1a84c85794632eb
  variables:
    GIT_DEPTH: 0
  before_script:
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  script:
    - git fetch --tags
    - latest_tag=$(git tag --sort=-v:refname | grep -E "^[0-9]+\.[0-9]+\.[0-9]+$" | head -n 1 || true)
    - latest_hotfix_tag=$(git tag --sort=-v:refname | grep "${latest_tag}\-fix" | head -n 1 || true)
    - latest_hotfix_tag=${latest_hotfix_tag:-"${latest_tag}-fix.0"}
    - fix_version=$(echo "${latest_hotfix_tag}" | awk -F. '{print $4}')
    - new_fix_version=$(($fix_version + 1))
    - new_tag="${latest_tag}-fix.${new_fix_version}"
    - echo "IMAGE_VERSION=$new_tag" >> version.env
    - git remote set-url origin https://oauth2:${PROJECT_ACCESS_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git
    - git tag "$new_tag"
    - git push origin "$new_tag"
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^hotfix\/.*$/
      when: on_success
  artifacts:
    reports:
      dotenv: version.env
  tags:
    - docker

create-release-version:
  stage: create-version
  image: alpine/git:v2.49.1@sha256:6a349a8e142f1e62429377904c5eff5ff3d956bfe2bdf8acc1a84c85794632eb
  variables:
    GIT_DEPTH: 0
  before_script:
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  script:
    - git fetch --tags
    - HOTFIX_VERSION=$(git tag --points-at $CI_COMMIT_SHA --sort=-v:refname | grep "fix." | head -n 1 || true)
    - |  
      if [[ "$HOTFIX_VERSION" ]]; then
        ORIGINAL_RELEASE_VERSION=$(echo "$HOTFIX_VERSION" | awk -F-fix. '{print $1}')
        patch=$(echo "$ORIGINAL_RELEASE_VERSION" | awk -F. '{print $3}')
        new_patch_version=$(($patch + 1))
        MAJOR_MINOR_VERSION=$(echo "$ORIGINAL_RELEASE_VERSION" | awk -F. '{print $1 "." $2}')
        IMAGE_VERSION="${MAJOR_MINOR_VERSION}.${new_patch_version}"
      else
        ORIGINAL_VERSION=$(git tag --points-at $CI_COMMIT_SHA --sort=-v:refname | grep "rc." | head -n 1 || true)
        IMAGE_VERSION=$(echo "$ORIGINAL_VERSION" | awk -F-rc. '{print $1}')
      fi
      
    - echo "IMAGE_VERSION=$IMAGE_VERSION" >> version.env
    - git remote set-url origin https://oauth2:${PROJECT_ACCESS_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git
    - git tag "$IMAGE_VERSION"
    - git push origin "$IMAGE_VERSION"
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"
      when: on_success
  artifacts:
    reports:
      dotenv: version.env
  tags:
    - docker